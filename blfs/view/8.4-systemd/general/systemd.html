<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content=
    "application/xhtml+xml; charset=iso-8859-1" />
    <title>
      Systemd-240
    </title>
    <link rel="stylesheet" href="../stylesheets/lfs.css" type="text/css" />
    <meta name="generator" content="DocBook XSL Stylesheets V1.73.2" />
    <link rel="stylesheet" href="../stylesheets/lfs-print.css" type=
    "text/css" media="print" />
  </head>
  <body class="blfs" id="blfs-8.4">
    <div class="navheader">
      <h4>
        Beyond Linux<sup>®</sup> From Scratch <span>(systemd edition)</span>
        - Version 8.4
      </h4>
      <h3>
        Chapter&nbsp;12.&nbsp;System Utilities
      </h3>
      <ul>
        <li class="prev">
          <a accesskey="p" href="sysstat.html" title=
          "Sysstat-12.1.2">Prev</a>
          <p>
            Sysstat-12.1.2
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="udisks2.html" title="UDisks-2.8.1">Next</a>
          <p>
            UDisks-2.8.1
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="sysutils.html" title=
          "Chapter&nbsp;12.&nbsp;System Utilities">Up</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Beyond Linux® From Scratch (systemd edition) - Version 8.4">Home</a>
        </li>
      </ul>
    </div>
    <div class="sect1" lang="en" xml:lang="en">
      <h1 class="sect1">
        <a id="systemd" name="systemd"></a>Systemd-240
      </h1>
      <div class="package" lang="en" xml:lang="en">
        <h2 class="sect2">
          Introduction to systemd
        </h2>
        <p>
          While <span class="application">systemd</span> was installed when
          building LFS, there are many features provided by the package that
          were not included in the initial installation because <span class=
          "application">Linux-PAM</span> was not yet installed. The
          <span class="application">systemd</span> package needs to be
          rebuilt to provide a working <span class=
          "command"><strong>systemd-logind</strong></span> service, which
          provides many additional features for dependent packages.
        </p>
        <p>
          This package is known to build and work properly using an LFS-8.4
          platform.
        </p>
        <h3>
          Package Information
        </h3>
        <div class="itemizedlist">
          <ul class="compact">
            <li>
              <p>
                Download (HTTP): <a class="ulink" href=
                "https://github.com/systemd/systemd/archive/v240/systemd-240.tar.gz">
                https://github.com/systemd/systemd/archive/v240/systemd-240.tar.gz</a>
              </p>
            </li>
            <li>
              <p>
                Download MD5 sum: 0e4f91b513d4b04e2c10a5173e5a87b2
              </p>
            </li>
            <li>
              <p>
                Download size: 7.2 MB
              </p>
            </li>
            <li>
              <p>
                Estimated disk space required: 222 MB (an additonal 11 MB for
                tests)
              </p>
            </li>
            <li>
              <p>
                Estimated build time: 2.2 SBU (&lt; 0.1 SBU for tests)
              </p>
            </li>
          </ul>
        </div>
        <h3>
          Additional Downloads
        </h3>
        <div class="itemizedlist">
          <ul class="compact">
            <li>
              <p>
                Required patch: <a class="ulink" href=
                "http://www.linuxfromscratch.org/patches/blfs/8.4/systemd-240-security_fixes-2.patch">
                http://www.linuxfromscratch.org/patches/blfs/8.4/systemd-240-security_fixes-2.patch</a>
              </p>
            </li>
          </ul>
        </div>
        <h3>
          systemd Dependencies
        </h3>
        <h4>
          Required
        </h4>
        <p class="required">
          <a class="xref" href="../postlfs/linux-pam.html" title=
          "Linux-PAM-1.3.0">Linux-PAM-1.3.0</a>
        </p>
        <h4>
          Recommended Runtime Dependencies
        </h4>
        <p class="recommended">
          <a class="xref" href="../postlfs/polkit.html" title=
          "Polkit-0.115">Polkit-0.115</a>
        </p>
        <h4>
          Optional
        </h4>
        <p class="optional">
          <a class="xref" href="../basicnet/curl.html" title=
          "cURL-7.64.0">cURL-7.64.0</a>, <a class="xref" href=
          "../postlfs/cryptsetup.html" title=
          "cryptsetup-2.0.6">cryptsetup-2.0.6</a>, <a class="xref" href=
          "git.html" title="Git-2.20.1">git-2.20.1</a>, <a class="xref" href=
          "../postlfs/gnutls.html" title="GnuTLS-3.6.6">GnuTLS-3.6.6</a>,
          <a class="xref" href="../postlfs/iptables.html" title=
          "Iptables-1.8.2">Iptables-1.8.2</a>, <a class="xref" href=
          "libgcrypt.html" title="libgcrypt-1.8.4">libgcrypt-1.8.4</a>,
          <a class="xref" href="libidn2.html" title=
          "libidn2-2.1.1">libidn2-2.1.1</a>, <a class="xref" href=
          "libseccomp.html" title="libseccomp-2.3.3">libseccomp-2.3.3</a>,
          <a class="xref" href="libxkbcommon.html" title=
          "libxkbcommon-0.8.3">libxkbcommon-0.8.3</a>, <a class="xref" href=
          "../postlfs/make-ca.html" title="make-ca-1.2">make-ca-1.2</a>,
          <a class="xref" href="../postlfs/qemu.html" title=
          "qemu-3.1.0">qemu-3.1.0</a>, <a class="xref" href="valgrind.html"
          title="Valgrind-3.14.0">Valgrind-3.14.0</a>, <a class="xref" href=
          "../postlfs/zsh.html" title="zsh-5.7.1">zsh-5.7.1</a> (for the zsh
          completions), <a class="ulink" href=
          "http://sourceforge.net/projects/gnu-efi/">gnu-efi</a>, <a class=
          "ulink" href=
          "https://www.kernel.org/pub/linux/utils/kernel/kexec/">kexec-tools</a>,
          <a class="ulink" href=
          "https://www.gnu.org/software/libmicrohttpd/">libmicrohttpd</a>,
          <a class="ulink" href="http://lz4.github.io/lz4/">lz4</a>,
          <a class="ulink" href=
          "http://fukuchi.org/works/qrencode/">qrencode</a>, <a class="ulink"
          href="http://sourceforge.net/projects/linuxquota/">quota-tools</a>
          and <a class="ulink" href=
          "https://pypi.python.org/pypi/Sphinx">Sphinx</a>
        </p>
        <h4>
          Optional (to rebuild the manual pages)
        </h4>
        <p class="optional">
          <a class="xref" href="../pst/docbook.html" title=
          "docbook-xml-4.5">docbook-xml-4.5</a>, <a class="xref" href=
          "../pst/docbook-xsl.html" title=
          "docbook-xsl-nons-1.79.2">docbook-xsl-1.79.2</a>, <a class="xref"
          href="libxslt.html" title="libxslt-1.1.33">libxslt-1.1.33</a>, and
          <a class="xref" href="python-modules.html#lxml" title=
          "lxml-4.3.1">lxml-4.3.1</a> (to build the index of systemd manual
          pages)
        </p>
        <p class="usernotes">
          User Notes: <a class="ulink" href=
          "http://wiki.linuxfromscratch.org/blfs/wiki/systemd">http://wiki.linuxfromscratch.org/blfs/wiki/systemd</a>
        </p>
      </div>
      <div class="installation" lang="en" xml:lang="en">
        <h2 class="sect2">
          Installation of systemd
        </h2>
        <p>
          Apply a critical security patch for journald:
        </p>
        <pre class="userinput">
<kbd class=
"command">patch -Np1 -i ../systemd-240-security_fixes-2.patch</kbd>
</pre>
        <p>
          Remove an unneeded group, <code class="systemitem">render</code>,
          from the default udev rules:
        </p>
        <pre class="userinput">
<kbd class=
"command">sed -i 's/GROUP="render", //' rules/50-udev-default.rules.in</kbd>
</pre>
        <p>
          Rebuild <span class="application">systemd</span> by running the
          following commands:
        </p>
        <pre class="userinput">
<kbd class="command">mkdir build &amp;&amp;
cd    build &amp;&amp;

meson --prefix=/usr         \
      --sysconfdir=/etc     \
      --localstatedir=/var  \
      -Dblkid=true          \
      -Dbuildtype=release   \
      -Ddefault-dnssec=no   \
      -Dfirstboot=false     \
      -Dinstall-tests=false \
      -Dldconfig=false      \
      -Drootprefix=         \
      -Drootlibdir=/lib     \
      -Dsplit-usr=true      \
      -Dsysusers=false      \
      -Db_lto=false         \
      ..                    &amp;&amp;

ninja</kbd>
</pre>
        <div class="admon note">
          <img alt="[Note]" src="../images/note.png" />
          <h3>
            Note
          </h3>
          <p>
            For the best test results, make sure you run the testsuite from a
            system that is booted by the same <span class=
            "application">systemd</span> version you are rebuilding.
          </p>
        </div>
        <p>
          To test the results, issue: <span class="command"><strong>ninja
          test</strong></span>.
        </p>
        <div class="admon warning">
          <img alt="[Warning]" src="../images/warning.png" />
          <h3>
            Warning
          </h3>
          <p>
            Installing the package will overwrite all files installed by
            <span class="application">systemd</span> in LFS. It is critical
            that nothing uses either <span class="application">systemd</span>
            or <span class="application">Udev</span> libraries during the
            installation. The best way to ensure that these libraries are not
            being used is to run the installation in rescue mode. To switch
            to rescue mode, run the following command as the <code class=
            "systemitem">root</code> user (from a TTY):
          </p>
          <pre class="root">
<kbd class="command">systemctl start rescue.target</kbd>
</pre>
        </div>
        <p>
          Now, as the <code class="systemitem">root</code> user:
        </p>
        <pre class="root">
<kbd class="command">ninja install</kbd>
</pre>
        <p>
          If <span class="application">RPM</span> is not installed, remove an
          unnecessary directory by running the following command as the
          <code class="systemitem">root</code> user:
        </p>
        <pre class="root">
<kbd class="command">rm -rfv /usr/lib/rpm</kbd>
</pre>
      </div>
      <div class="configuration" lang="en" xml:lang="en">
        <h2 class="sect2">
          Configuring systemd
        </h2>
        <p>
          The <code class="filename">/etc/pam.d/system-session</code> file
          needs to be modified and a new file needs to be created in order
          for <span class="command"><strong>systemd-logind</strong></span> to
          work correctly. Run the following commands as the <code class=
          "systemitem">root</code> user:
        </p>
        <pre class="root">
<kbd class="command">cat &gt;&gt; /etc/pam.d/system-session &lt;&lt; "EOF"
<code class="literal"># Begin Systemd addition
    
session  required    pam_loginuid.so
session  optional    pam_systemd.so

# End Systemd addition</code>
EOF

cat &gt; /etc/pam.d/systemd-user &lt;&lt; "EOF"
<code class="literal"># Begin /etc/pam.d/systemd-user

account  required    pam_access.so
account  include     system-account

session  required    pam_env.so
session  required    pam_limits.so
session  required    pam_unix.so
session  required    pam_loginuid.so
session  optional    pam_keyinit.so force revoke
session  optional    pam_systemd.so

auth     required    pam_deny.so
password required    pam_deny.so

# End /etc/pam.d/systemd-user</code>
EOF</kbd>
</pre>
        <p>
          At this point, you should reload the systemd daemon, and reenter
          multi-user mode with the following commands (as the <code class=
          "systemitem">root</code> user):
        </p>
        <pre class="root">
<kbd class="command">systemctl daemon-reload
systemctl start multi-user.target</kbd>
</pre>
        <div class="admon warning">
          <img alt="[Warning]" src="../images/warning.png" />
          <h3>
            Warning
          </h3>
          <p>
            If upgrading from a previous version of systemd and an initrd is
            used for system boot, you should generate a new initrd before
            rebooting the system.
          </p>
        </div>
      </div>
      <div class="content" lang="en" xml:lang="en">
        <h2 class="sect2">
          Contents
        </h2>
        <p>
          A list of the installed files, along with their short descriptions
          can be found at <a class="ulink" href=
          "../../../../lfs/view/8.4/chapter06/systemd.html#contents-systemd">../../../../lfs/view/8.4/chapter06/systemd.html#contents-systemd</a>.
        </p>
        <p>
          Listed below are the newly installed libraries and directories
          along with short descriptions.
        </p>
        <div class="segmentedlist">
          <div class="seglistitem">
            <div class="seg">
              <strong class="segtitle">Installed Programs:</strong>
              <span class="segbody">None</span>
            </div>
            <div class="seg">
              <strong class="segtitle">Installed Libraries:</strong>
              <span class="segbody">pam_systemd.so (in <code class=
              "filename">/lib/security</code>)</span>
            </div>
            <div class="seg">
              <strong class="segtitle">Installed Directories:</strong>
              <span class="segbody">None</span>
            </div>
          </div>
        </div>
        <div class="variablelist">
          <h3>
            Short Descriptions
          </h3>
          <table border="0">
            <col align="left" valign="top" />
            <tbody>
              <tr>
                <td>
                  <p>
                    <a id="pam_systemd" name="pam_systemd"></a><span class=
                    "term"><code class=
                    "filename">pam_systemd.so</code></span>
                  </p>
                </td>
                <td>
                  <p>
                    is a PAM module used to register user sessions with the
                    <span class="application">systemd</span> login manager,
                    <span class=
                    "command"><strong>systemd-logind</strong></span>.
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <p class="updated">
        Last updated on 2019-02-25 07:49:35 -0800
      </p>
    </div>
    <div class="navfooter">
      <ul>
        <li class="prev">
          <a accesskey="p" href="sysstat.html" title=
          "Sysstat-12.1.2">Prev</a>
          <p>
            Sysstat-12.1.2
          </p>
        </li>
        <li class="next">
          <a accesskey="n" href="udisks2.html" title="UDisks-2.8.1">Next</a>
          <p>
            UDisks-2.8.1
          </p>
        </li>
        <li class="up">
          <a accesskey="u" href="sysutils.html" title=
          "Chapter&nbsp;12.&nbsp;System Utilities">Up</a>
        </li>
        <li class="home">
          <a accesskey="h" href="../index.html" title=
          "Beyond Linux® From Scratch (systemd edition) - Version 8.4">Home</a>
        </li>
      </ul>
    </div>
  </body>
</html>
